name: Azurite Blob Storage Setup

on:
  workflow_dispatch:

jobs:
  setup-azurite:
    runs-on: ubuntu-latest

    steps:
    - name: Install Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install Azurite
      run: npm install -g azurite

    - name: Start Azurite
      run: |
        nohup azurite --blobHost 127.0.0.1 --blobPort 10000 \
                      --queueHost 127.0.0.1 --queuePort 10001 \
                      --tableHost 127.0.0.1 --tablePort 10002 &


    - name: Install Azure CLI
      run: pip install azure-cli
    
    - name: show network
      run: az storage account show -n accountname --query networkRuleSet

    - name: Create Blob Container
      run: az storage container create --name mycontainer --public-access container
      env:
        AZURE_STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFeqCnbXn==;BlobEndpoint=http://127.0.0.1:10000/devstoreaccount1;QueueEndpoint=http://127.0.0.1:10001/devstoreaccount1;TableEndpoint=http://127.0.0.1:10002/devstoreaccount1"

    - name: Upload Blob
      run: az storage blob upload --container-name mycontainer --name test.yml --file test.yml
      env:
        AZURE_STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFeqCnbXn==;BlobEndpoint=http://127.0.0.1:10000/devstoreaccount1;QueueEndpoint=http://127.0.0.1:10001/devstoreaccount1;TableEndpoint=http://127.0.0.1:10002/devstoreaccount1"

    - name: List Blobs
      run: az storage blob list --container-name mycontainer --output table
      env:
        AZURE_STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFeqCnbXn==;BlobEndpoint=http://127.0.0.1:10000/devstoreaccount1;QueueEndpoint=http://127.0.0.1:10001/devstoreaccount1;TableEndpoint=http://127.0.0.1:10002/devstoreaccount1"

    - name: Generate SAS Token
      run: |
        az storage blob generate-sas \
          --account-name devstoreaccount1 \
          --container-name mycontainer \
          --name test.yml \
          --permissions r \
          --expiry 2025-08-25T23:59:59Z \
          --https-only
      env:
        AZURE_STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFeqCnbXn==;BlobEndpoint=http://127.0.0.1:10000/devstoreaccount1;QueueEndpoint=http://127.0.0.1:10001/devstoreaccount1;TableEndpoint=http://127.0.0.1:10002/devstoreaccount1"